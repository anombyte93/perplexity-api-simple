<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perplexity API Free - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .status {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .generate-section {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 20px;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
        }

        .btn-small {
            padding: 6px 15px;
            font-size: 0.85em;
        }

        .keys-list {
            display: grid;
            gap: 15px;
        }

        .key-item {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 20px;
            align-items: center;
            transition: transform 0.2s;
        }

        .key-item:hover {
            transform: translateX(5px);
        }

        .key-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .key-value {
            font-family: 'Courier New', monospace;
            background: white;
            padding: 10px 15px;
            border-radius: 6px;
            font-size: 0.9em;
            color: #667eea;
            font-weight: bold;
            cursor: pointer;
            display: inline-block;
            max-width: 500px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .key-meta {
            font-size: 0.85em;
            color: #666;
        }

        .key-actions {
            display: flex;
            gap: 10px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        .copy-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: slideInRight 0.3s ease;
            z-index: 1000;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 10px;
        }

        .badge-active {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .usage-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        /* AI Providers Section */
        .providers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .provider-card {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
        }

        .provider-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }

        .provider-card.active {
            border-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
        }

        .provider-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .provider-icon {
            font-size: 2.5em;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .provider-info {
            flex: 1;
        }

        .provider-name {
            font-size: 1.2em;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }

        .provider-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }

        .provider-status.active {
            background: #d1fae5;
            color: #065f46;
        }

        .provider-status.coming-soon {
            background: #dbeafe;
            color: #1e40af;
        }

        .provider-details {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .provider-models {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 12px;
        }

        .provider-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e0;
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        .toggle-switch input:disabled + .toggle-slider {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .providers-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .coming-soon-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Perplexity API Free</h1>
            <p class="subtitle">Self-hosted API server with web dashboard</p>
            <span class="status" id="statusBadge">üü¢ Server Online</span>
        </div>

        <div class="card">
            <h2>üìä Statistics</h2>
            <div class="usage-stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalKeys">0</div>
                    <div class="stat-label">Total Keys</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeKeys">0</div>
                    <div class="stat-label">Active Keys</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalUsage">0</div>
                    <div class="stat-label">Total Requests</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="providers-header">
                <h2>üåê AI Providers</h2>
                <span class="coming-soon-badge">More Coming Soon!</span>
            </div>
            <div class="alert alert-info">
                <strong>üöÄ Expanding Horizons:</strong> We're working on adding more AI providers to give you access to the best models from multiple platforms!
                <br><small>Enable/disable providers based on your needs. Each provider requires its own authentication.</small>
            </div>
            <div class="providers-grid" id="providersGrid">
                <!-- Providers will be loaded dynamically -->
            </div>
        </div>

        <div class="card">
            <h2>üß© Chrome Extension</h2>
            <div class="alert alert-info">
                <strong>üì• Download Extension:</strong> Install the Chrome extension for one-click setup with Claude Code MCP.
                <br><small>The extension auto-extracts your Perplexity cookie and configures Claude Code for you.</small>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <button onclick="downloadExtension()" style="flex: 0 0 auto;">
                    üì¶ Download Chrome Extension
                </button>
                <div style="flex: 1; font-size: 0.9em; color: #666;">
                    <strong>Current Version:</strong> <span id="extensionVersion">Loading...</span>
                </div>
            </div>
            <div style="margin-top: 20px; font-size: 0.9em; opacity: 0.8;">
                <details>
                    <summary style="cursor: pointer; user-select: none;">üí° Installation Instructions</summary>
                    <div style="margin-top: 10px; line-height: 1.8;">
                        1. Click the download button above<br>
                        2. Extract the downloaded zip file<br>
                        3. Open Chrome ‚Üí <code>chrome://extensions/</code><br>
                        4. Enable "Developer mode" (top-right toggle)<br>
                        5. Click "Load unpacked" and select the extracted folder<br>
                        6. Click the extension icon and follow setup instructions
                    </div>
                </details>
            </div>
        </div>

        <div class="card">
            <h2>üí∞ Cost Savings</h2>
            <div class="alert alert-info">
                <strong>üìä Track Your Savings:</strong> See how much you've saved by using this free server instead of the official Perplexity API.
                <br><small>Calculated using official Perplexity Sonar-Pro pricing ($3/1M input tokens, $15/1M output tokens)</small>
            </div>
            <div class="usage-stats">
                <div class="stat-card">
                    <div class="stat-value" style="color: #10b981;" id="totalSaved">$0.00</div>
                    <div class="stat-label">Total Saved (Sonar-Pro)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTokens">0</div>
                    <div class="stat-label">Total Tokens</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="tokenBreakdown">0 in / 0 out</div>
                    <div class="stat-label">Token Breakdown</div>
                </div>
            </div>
            <div style="margin-top: 20px; font-size: 0.9em; opacity: 0.8;">
                <details>
                    <summary style="cursor: pointer; user-select: none;">üí° Show cost breakdown by model</summary>
                    <div id="costBreakdown" style="margin-top: 10px; font-family: monospace; font-size: 0.85em;"></div>
                </details>
            </div>
        </div>

        <div class="card">
            <h2>üç™ Perplexity Cookie (Pro Access)</h2>
            <div class="alert alert-info">
                <strong>üí° Enable Pro Features:</strong> Add your Perplexity account cookie to access Pro, Reasoning, and Deep Research modes.
                <br><small>Get cookie: Open perplexity.ai ‚Üí F12 ‚Üí Console ‚Üí Type: <code>document.cookie</code></small>
            </div>
            <div class="generate-section">
                <input type="text" id="cookieInput" placeholder="Paste your Perplexity cookie here..." style="font-family: monospace; font-size: 0.9em;">
                <button onclick="saveCookie()">Save Cookie</button>
            </div>
            <div id="cookieStatus" style="margin-top: 15px;"></div>
            <div style="margin-top: 15px;">
                <button class="btn-small btn-danger" onclick="clearCookie()">Clear Cookie</button>
            </div>
        </div>

        <div class="card">
            <h2>üîë Generate New API Key</h2>
            <div class="generate-section">
                <input type="text" id="keyName" placeholder="Key name (e.g., 'TaskMaster', 'Claude Code', 'My App')" value="My API Key">
                <button onclick="generateKey()">Generate API Key</button>
            </div>
            <div id="newKeyAlert" style="display: none;"></div>
        </div>

        <div class="card">
            <h2>üìã Your API Keys</h2>
            <div id="keysList"></div>
        </div>
    </div>

    <script>
        let keys = [];
        let providers = [];

        async function loadProviders() {
            try {
                const response = await fetch('/api/providers');
                const data = await response.json();

                if (data.success) {
                    providers = data.providers;
                    renderProviders();
                }
            } catch (error) {
                console.error('Error loading providers:', error);
                // Show default providers if endpoint fails
                showDefaultProviders();
            }
        }

        function renderProviders() {
            const container = document.getElementById('providersGrid');

            if (!providers || providers.length === 0) {
                showDefaultProviders();
                return;
            }

            container.innerHTML = providers.map(provider => `
                <div class="provider-card ${provider.status === 'active' ? 'active' : ''}">
                    <div class="provider-header">
                        <div class="provider-icon">${provider.icon}</div>
                        <div class="provider-info">
                            <div class="provider-name">${escapeHtml(provider.name)}</div>
                            <span class="provider-status ${provider.status === 'active' ? 'active' : 'coming-soon'}">
                                ${provider.status === 'active' ? '‚úÖ Active' : 'üîÑ Coming Soon'}
                            </span>
                        </div>
                    </div>
                    <div class="provider-details">
                        <div class="provider-models">
                            <strong>${provider.model_count}</strong> model${provider.model_count !== 1 ? 's' : ''} available
                        </div>
                        <div class="provider-toggle">
                            <span style="font-size: 0.9em; color: #666;">Enable Provider</span>
                            <label class="toggle-switch">
                                <input
                                    type="checkbox"
                                    ${provider.enabled ? 'checked' : ''}
                                    ${provider.status === 'coming-soon' ? 'disabled' : ''}
                                    onchange="toggleProvider('${provider.id}', this.checked)"
                                >
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        ${provider.description ? `<div style="margin-top: 12px; font-size: 0.85em; color: #666; font-style: italic;">${escapeHtml(provider.description)}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function showDefaultProviders() {
            // Default providers data (fallback if API fails)
            const defaultProviders = [
                {
                    id: 'perplexity',
                    name: 'Perplexity',
                    icon: 'üîÆ',
                    status: 'active',
                    model_count: 5,
                    enabled: true,
                    description: 'Search-focused AI with real-time web access'
                },
                {
                    id: 'claude',
                    name: 'Claude',
                    icon: 'ü§ñ',
                    status: 'coming-soon',
                    model_count: 4,
                    enabled: false,
                    description: 'Anthropic\'s powerful AI assistant'
                },
                {
                    id: 'gemini',
                    name: 'Gemini',
                    icon: '‚ú®',
                    status: 'coming-soon',
                    model_count: 3,
                    enabled: false,
                    description: 'Google\'s advanced AI models'
                },
                {
                    id: 'xai',
                    name: 'xAI (Grok)',
                    icon: 'üöÄ',
                    status: 'coming-soon',
                    model_count: 2,
                    enabled: false,
                    description: 'Elon Musk\'s cutting-edge AI'
                },
                {
                    id: 'cursor',
                    name: 'Cursor',
                    icon: 'üíª',
                    status: 'coming-soon',
                    model_count: 1,
                    enabled: false,
                    description: 'AI-powered code editor integration'
                }
            ];

            providers = defaultProviders;
            renderProviders();
        }

        async function toggleProvider(providerId, enabled) {
            try {
                const response = await fetch('/api/toggle-provider', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ provider_id: providerId, enabled })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification(`${providerId} ${enabled ? 'enabled' : 'disabled'} successfully`);
                    await loadProviders();
                } else {
                    showNotification('Error toggling provider: ' + (data.error || 'Unknown error'));
                    // Reload to reset state
                    await loadProviders();
                }
            } catch (error) {
                console.error('Error toggling provider:', error);
                showNotification('Error toggling provider');
                // Reload to reset state
                await loadProviders();
            }
        }

        async function loadKeys() {
            try {
                const response = await fetch('/api/list-keys');
                const data = await response.json();

                if (data.success) {
                    keys = data.keys;
                    renderKeys();
                    updateStats();
                }
            } catch (error) {
                console.error('Error loading keys:', error);
            }
        }

        async function loadCostSavings() {
            try {
                const response = await fetch('/api/cost-savings');
                const data = await response.json();

                if (data.success) {
                    // Update main cost display with smart formatting
                    const totalCost = data.cost_saved_usd.total;
                    let costDisplay;
                    if (totalCost >= 1) {
                        costDisplay = '$' + totalCost.toFixed(2);
                    } else if (totalCost >= 0.01) {
                        costDisplay = '$' + totalCost.toFixed(4);
                    } else if (totalCost > 0) {
                        // Show in cents for very small amounts
                        costDisplay = (totalCost * 100).toFixed(4) + '¬¢';
                    } else {
                        costDisplay = '$0.00';
                    }

                    document.getElementById('totalSaved').textContent = costDisplay;
                    document.getElementById('totalTokens').textContent = data.tokens.total.toLocaleString();
                    document.getElementById('tokenBreakdown').textContent =
                        `${data.tokens.input.toLocaleString()} in / ${data.tokens.output.toLocaleString()} out`;

                    // Update detailed cost breakdown
                    const costBreakdown = document.getElementById('costBreakdown');
                    let breakdownHTML = '<table style="width: 100%; border-collapse: collapse;">';
                    breakdownHTML += '<tr style="border-bottom: 1px solid #333;"><th style="text-align: left; padding: 5px;">Model</th><th style="text-align: right; padding: 5px;">Input Cost</th><th style="text-align: right; padding: 5px;">Output Cost</th><th style="text-align: right; padding: 5px;">Total Saved</th></tr>';

                    for (const [model, costs] of Object.entries(data.costs_by_model)) {
                        const displayName = model.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

                        // Smart formatting for costs
                        const formatCost = (cost) => {
                            if (cost >= 1) return '$' + cost.toFixed(2);
                            if (cost >= 0.01) return '$' + cost.toFixed(4);
                            if (cost > 0) return (cost * 100).toFixed(4) + '¬¢';
                            return '$0.00';
                        };

                        breakdownHTML += `
                            <tr style="border-bottom: 1px solid #222;">
                                <td style="padding: 5px;">${displayName}</td>
                                <td style="text-align: right; padding: 5px;">${formatCost(costs.input_cost)}</td>
                                <td style="text-align: right; padding: 5px;">${formatCost(costs.output_cost)}</td>
                                <td style="text-align: right; padding: 5px; font-weight: bold; color: #10b981;">${formatCost(costs.total)}</td>
                            </tr>
                        `;
                    }

                    breakdownHTML += '</table>';
                    breakdownHTML += '<div style="margin-top: 10px; opacity: 0.7; font-size: 0.9em;">Based on official Perplexity API pricing (2025)</div>';
                    costBreakdown.innerHTML = breakdownHTML;
                }
            } catch (error) {
                console.error('Error loading cost savings:', error);
            }
        }

        function updateStats() {
            const totalKeys = keys.length;
            const activeKeys = keys.filter(k => k.active).length;
            const totalUsage = keys.reduce((sum, k) => sum + (k.usage_count || 0), 0);

            document.getElementById('totalKeys').textContent = totalKeys;
            document.getElementById('activeKeys').textContent = activeKeys;
            document.getElementById('totalUsage').textContent = totalUsage;
        }

        function renderKeys() {
            const container = document.getElementById('keysList');

            if (keys.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                        </svg>
                        <h3>No API keys yet</h3>
                        <p>Generate your first API key to get started!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '<div class="keys-list">' + keys.map(key => `
                <div class="key-item">
                    <div class="key-info">
                        <div>
                            <strong>${escapeHtml(key.name)}</strong>
                            <span class="badge ${key.active ? 'badge-active' : 'badge-inactive'}">
                                ${key.active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                        <div class="key-value" onclick="copyKey('${key.full_key}')" title="Click to copy">
                            ${key.full_key}
                        </div>
                        <div class="key-meta">
                            Created: ${new Date(key.created).toLocaleString()} |
                            Last used: ${key.last_used ? new Date(key.last_used).toLocaleString() : 'Never'} |
                            Usage: ${key.usage_count || 0} requests
                        </div>
                    </div>
                    <div class="key-actions">
                        <button class="btn-small" onclick="toggleKey('${key.full_key}')">
                            ${key.active ? 'Disable' : 'Enable'}
                        </button>
                        <button class="btn-small btn-danger" onclick="deleteKey('${key.full_key}')">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('') + '</div>';
        }

        async function generateKey() {
            const name = document.getElementById('keyName').value || 'Unnamed Key';

            try {
                const response = await fetch('/api/generate-key', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name })
                });

                const data = await response.json();

                if (data.success) {
                    const alertDiv = document.getElementById('newKeyAlert');
                    alertDiv.innerHTML = `
                        <div class="alert alert-success">
                            <strong>‚úÖ API Key Generated!</strong><br>
                            <div class="key-value" onclick="copyKey('${data.api_key}')" style="margin-top: 10px; cursor: pointer;">
                                ${data.api_key}
                            </div>
                            <small style="display: block; margin-top: 10px;">
                                Click to copy. Save this key - you won't be able to see it again after refreshing!
                            </small>
                        </div>
                    `;
                    alertDiv.style.display = 'block';

                    // Clear input
                    document.getElementById('keyName').value = '';

                    // Reload keys
                    await loadKeys();

                    // Auto-hide alert after 10 seconds
                    setTimeout(() => {
                        alertDiv.style.display = 'none';
                    }, 10000);
                }
            } catch (error) {
                console.error('Error generating key:', error);
                alert('Error generating key. Check console for details.');
            }
        }

        async function deleteKey(key) {
            if (!confirm('Are you sure you want to delete this API key? This cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/api/delete-key', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ key })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Key deleted successfully');
                    await loadKeys();
                }
            } catch (error) {
                console.error('Error deleting key:', error);
                alert('Error deleting key. Check console for details.');
            }
        }

        async function toggleKey(key) {
            try {
                const response = await fetch('/api/toggle-key', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ key })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification(`Key ${data.active ? 'enabled' : 'disabled'} successfully`);
                    await loadKeys();
                }
            } catch (error) {
                console.error('Error toggling key:', error);
                alert('Error toggling key. Check console for details.');
            }
        }

        function copyKey(key) {
            navigator.clipboard.writeText(key).then(() => {
                showNotification('‚úÖ API key copied to clipboard!');
            });
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'copy-notification';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function loadCookieStatus() {
            try {
                const response = await fetch('/api/cookie-status');
                const data = await response.json();

                const statusDiv = document.getElementById('cookieStatus');
                if (data.has_cookie) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            ‚úÖ Cookie is set - Pro features enabled!<br>
                            <small>Cookie preview: ${data.cookie_preview || '***'}</small>
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="alert alert-info">
                            ‚ÑπÔ∏è No cookie set - running in anonymous mode (limited features)
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading cookie status:', error);
            }
        }

        async function saveCookie() {
            const cookie = document.getElementById('cookieInput').value.trim();

            if (!cookie) {
                alert('Please enter a cookie value');
                return;
            }

            try {
                const response = await fetch('/api/save-cookie', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ cookie })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('cookieInput').value = '';

                    if (data.requires_restart) {
                        showNotification('‚úÖ Cookie saved! Please restart server manually.');
                    } else {
                        showNotification('‚úÖ Cookie hot-reloaded! Pro features enabled instantly!');
                    }

                    // Reload cookie status
                    setTimeout(async () => {
                        await loadCookieStatus();
                    }, 500);
                } else {
                    alert('Error saving cookie: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error saving cookie:', error);
                alert('Error saving cookie. Check console for details.');
            }
        }

        async function clearCookie() {
            if (!confirm('Are you sure you want to clear the Perplexity cookie? Pro features will be disabled.')) {
                return;
            }

            try {
                const response = await fetch('/api/clear-cookie', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('‚úÖ Cookie cleared. Restarting server...');

                    // Wait a moment for server restart, then reload status
                    setTimeout(async () => {
                        await loadCookieStatus();
                        showNotification('‚úÖ Server restarted in anonymous mode.');
                    }, 2000);
                } else {
                    alert('Error clearing cookie: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error clearing cookie:', error);
                alert('Error clearing cookie. Check console for details.');
            }
        }

        async function downloadExtension() {
            try {
                showNotification('üì• Downloading extension...');

                // Create a temporary link and click it to trigger download
                const a = document.createElement('a');
                a.href = '/download/extension';
                a.download = 'perplexity-api-free-extension.zip';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);

                showNotification('‚úÖ Extension download started!');
            } catch (error) {
                console.error('Error downloading extension:', error);
                showNotification('‚ùå Error downloading extension');
            }
        }

        async function loadExtensionVersion() {
            try {
                const response = await fetch('/api/version');
                const data = await response.json();

                if (data.extension_version) {
                    document.getElementById('extensionVersion').textContent = 'v' + data.extension_version;
                }
            } catch (error) {
                console.error('Error loading extension version:', error);
                document.getElementById('extensionVersion').textContent = 'Unknown';
            }
        }

        // Load keys, cookie status, cost savings, providers, and extension version on page load
        loadKeys();
        loadCookieStatus();
        loadCostSavings();
        loadProviders();
        loadExtensionVersion();

        // Refresh every 30 seconds
        setInterval(loadKeys, 30000);
        setInterval(loadCookieStatus, 30000);
        setInterval(loadCostSavings, 30000);
        setInterval(loadProviders, 60000); // Refresh providers every 60 seconds
    </script>
</body>
</html>
